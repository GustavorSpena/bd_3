create database trab_3;

\c trab_3;

CREATE TABLE EVENTO(
  ANO INTEGER PRIMARY KEY ,
  TITULO VARCHAR(50) NOT NULL
);

/* stripar cnpj? tirar . e - do 66.991.613-0001-43 */

CREATE TABLE EMPRESA(
  CNPJ VARCHAR(20) PRIMARY KEY,
  NOME VARCHAR(50) NOT NULL,
  SETOR VARCHAR(50) NOT NULL
);

/* Tabela Participa
Nota de Feedback: deve necessariamente ser de 0 a 10, atendendo a metodologia de Net Promoter Score (NPS). 
Total Pago: não pode ser nulo, pois deve-se saber a todo momento quanto a empresa já pagou. Um valor nulo não faz sentido, 
portanto é sempre inicializado como 0 se outro valor nao for fornecido. 
*/
CREATE TABLE PARTICIPA(
  EVENTO INTEGER NOT NULL,
  EMPRESA VARCHAR(20) NOT NULL,
  TOTAL_PAGO DOUBLE PRECISION DEFAULT 0 NOT NULL,
  NOTA_FEEDBACK INTEGER,
  CONSTRAINT FK_EVENTO FOREIGN KEY (EVENTO) REFERENCES EVENTO(ANO)ON DELETE CASCADE,
  CONSTRAINT FK_EMPRESA FOREIGN KEY (EMPRESA) REFERENCES EMPRESA(CNPJ)ON DELETE CASCADE,
  CONSTRAINT PK_PARTICIPA PRIMARY KEY (EVENTO,EMPRESA),
  CHECK (NOTA_FEEDBACK IS NULL OR (NOTA_FEEDBACK >= 0 AND NOTA_FEEDBACK <= 10))
);

CREATE TABLE ESTANDE(
  TITULO VARCHAR(50),
  EVENTO INTEGER ,
  TAMANHO INTEGER,
  LOCALIZACAO VARCHAR(50),
  CONSTRAINT FK_ESTANDE_EVENTO FOREIGN KEY (EVENTO) REFERENCES EVENTO(ANO),
  CONSTRAINT PK_EVENTO_ESTANDE PRIMARY KEY (EVENTO,TITULO)
);

/* Colocar check para HINICIO  < HFIM */
CREATE TABLE PROGRAMACAO(
  HINICIO TIMESTAMP(0),
  NOME VARCHAR(50),
  TITULO VARCHAR(50),
  EVENTO INTEGER,
  HFIM TIMESTAMP(0),
  DESCRICAO VARCHAR(100),
  CONSTRAINT FK_TITULO FOREIGN KEY (TITULO, EVENTO) REFERENCES ESTANDE(TITULO, EVENTO),
  CONSTRAINT PK_PROGRAMACAO PRIMARY KEY (HINICIO,NOME)
);

CREATE TABLE PRODUTO(
  CODIGO VARCHAR(20) PRIMARY KEY,
  NOME VARCHAR(100) NOT NULL,
  FABRICANTE VARCHAR(20) NOT NULL, 
  PRECO DOUBLE PRECISION NOT NULL,
  LOTE DOUBLE PRECISION NOT NULL,
  TIPO VARCHAR(20) NOT NULL,
  CHECK (UPPER(TIPO) IN ('JOGO', 'PRODUTO'))
);

CREATE TABLE POSSUI(
  ESTANDE VARCHAR(20),
  ANO INTEGER,
  PRODUTO VARCHAR(20)NOT NULL,
  QUANTIDADE DOUBLE PRECISION NOT NULL,
  CONSTRAINT FK_POSSUI_ESTANDE FOREIGN KEY (ESTANDE, ANO) REFERENCES ESTANDE(TITULO, EVENTO),
  CONSTRAINT FK_POSSUI_PRODUTO FOREIGN KEY (PRODUTO) REFERENCES PRODUTO(CODIGO),
  CONSTRAINT PK_POSSUI PRIMARY KEY (ESTANDE, ANO, PRODUTO)
);


CREATE TABLE VENDEDOR(
  CPF VARCHAR(20) PRIMARY KEY,
  NOME VARCHAR(50)
);

/* Checar cpf valido? */
CREATE TABLE EMPREGA(
  ESTANDE VARCHAR(20),
  ANO INTEGER,
  CPF VARCHAR(20),
  CONSTRAINT FK_EMPREGA_ESTANDE FOREIGN KEY (ESTANDE, ANO) REFERENCES ESTANDE(TITULO, EVENTO),
  CONSTRAINT FK_EMPREGA_VENDEDOR FOREIGN KEY (CPF) REFERENCES VENDEDOR(CPF),
  CONSTRAINT PK_EMREGA PRIMARY KEY (ESTANDE, ANO,CPF)
);

/* Checar cpf valido? */
CREATE TABLE PESSOA(
  CPF VARCHAR(20) PRIMARY KEY,
  NOME VARCHAR(50)
);

CREATE TABLE VENDA(
  NF VARCHAR(20) PRIMARY KEY,
  DATA TIMESTAMP(0) NOT NULL,
  CLIENTE VARCHAR(20),
  VENDEDOR VARCHAR(20),
  CONSTRAINT FK_CLIENTE FOREIGN KEY (CLIENTE) REFERENCES PESSOA(CPF),
  CONSTRAINT FK_VENDEDOR FOREIGN KEY (VENDEDOR) REFERENCES VENDEDOR(CPF)
);

CREATE TABLE PRODUTOVENDA(
  PRODUTO VARCHAR(20),
  NF VARCHAR(20),
  QUANTIDADE DOUBLE PRECISION NOT NULL,
  CONSTRAINT FK_PRODUTO FOREIGN KEY (PRODUTO) REFERENCES PRODUTO(CODIGO),
  CONSTRAINT FK_NF FOREIGN KEY (NF) REFERENCES VENDA(NF),
  CONSTRAINT PK_PROTUTOVENDA PRIMARY KEY (PRODUTO,NF),
  CHECK (QUANTIDADE > 0)
);

CREATE TABLE CONSOLE(
  CODIGO VARCHAR(20),
  HARDESPC VARCHAR(200),
  CONSTRAINT FK_CODIGO FOREIGN KEY (CODIGO) REFERENCES PRODUTO(CODIGO),
  CONSTRAINT PK_CODIGO PRIMARY KEY (CODIGO) 
);

CREATE TABLE JOGO(
  CODIGO VARCHAR(20),
  PLATAFORMA VARCHAR(20),
  CONSTRAINT FK_JOGO_CODIGO FOREIGN KEY (CODIGO) REFERENCES PRODUTO(CODIGO),
  CONSTRAINT PK_JOGO_CODIGO PRIMARY KEY (CODIGO) 
);

CREATE TABLE TESTA(
  CPFCLIENTE VARCHAR(20),
  CODPROD VARCHAR(20),
  NOTA DOUBLE PRECISION,
  COMENTARIO VARCHAR(200),
  CONSTRAINT FK_CPFCLIENTE FOREIGN KEY (CPFCLIENTE) REFERENCES PESSOA(CPF),
  CONSTRAINT FK_CODPROD FOREIGN KEY (CODPROD) REFERENCES PRODUTO(CODIGO),
  CONSTRAINT PK_TESTA PRIMARY KEY (CPFCLIENTE,CODPROD), 
  CHECK (NOTA >= 0 AND NOTA <= 10)
);

CREATE TABLE TELEFONECLIENTE(
  CLIENTE VARCHAR(20),
  TELEFONE VARCHAR(12),
  CONSTRAINT PK_TELEFONECLIENTE PRIMARY KEY (CLIENTE,TELEFONE) 
);

CREATE TABLE TELEFENOVENDEDOR(
  VENDEDOR VARCHAR(20),
  TELEFONE VARCHAR(12),
  CONSTRAINT PK_TELEFENOVENDEDOR PRIMARY KEY (VENDEDOR,TELEFONE) 
);

CREATE TABLE PARTICIPAPROG(
  CPFCLIENTE VARCHAR(20),
  PROGRAMACAO VARCHAR(20),
  HINICIO TIMESTAMP(0),
  CONSTRAINT FK_PARTICIPAPROG_CPFCLIENTE FOREIGN KEY (CPFCLIENTE) REFERENCES PESSOA(CPF),
  CONSTRAINT FK_PARTICIPAPROG_PROGRAMACAO FOREIGN KEY (PROGRAMACAO, HINICIO) REFERENCES PROGRAMACAO(NOME, HINICIO),
  CONSTRAINT PK_PARTICIPAPROG PRIMARY KEY (CPFCLIENTE,PROGRAMACAO,HINICIO) 
);


INSERT INTO EVENTO (ANO, TITULO) VALUES (2019, 'Games XP 2k19');
INSERT INTO EVENTO (ANO, TITULO) VALUES (2018, 'Games XP 2018 the force awakens');
INSERT INTO EVENTO (ANO, TITULO) VALUES (2017, 'Games XP 2017');
INSERT INTO EVENTO (ANO, TITULO) VALUES (2016, 'Games XP 2016');
INSERT INTO EVENTO (ANO, TITULO) VALUES (2015, 'Games XP 2015');

INSERT INTO EMPRESA(CNPJ, NOME, SETOR) VALUES ('66991613000126', 'Nintendo', 'Jogos Eletrônicos');
INSERT INTO EMPRESA(CNPJ, NOME, SETOR) VALUES ('66991613000120', 'Redbull.', 'Alimentos');
INSERT INTO EMPRESA(CNPJ, NOME, SETOR) VALUES ('62399161300024', 'Sony.', 'Eletrônicos');

INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2019', '66991613000126', DEFAULT, NULL);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2019', '66991613000120', DEFAULT, NULL);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2019', '62399161300024', DEFAULT, NULL);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2018', '66991613000126', 80000, 9);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2018', '66991613000120', 60000, 8);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2018', '62399161300024', 50000, 4);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2017', '66991613000126', 80000, 7);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2017', '66991613000120', 50000, 8);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2017', '62399161300024', 30000, 9);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2016', '66991613000126', 50000, 8);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2016', '66991613000120', 10000, 7);
INSERT INTO PARTICIPA(EVENTO, EMPRESA, TOTAL_PAGO, NOTA_FEEDBACK) VALUES ('2016', '62399161300024', 5000, 7);

INSERT INTO ESTANDE(TITULO, EVENTO, TAMANHO, LOCALIZACAO) VALUES ('Nintendo Ultra', '2019', 70, 'SETOR A');
INSERT INTO ESTANDE(TITULO, EVENTO, TAMANHO, LOCALIZACAO) VALUES ('Redbull Xtreme', '2019', 120, 'SETOR A');
INSERT INTO ESTANDE(TITULO, EVENTO, TAMANHO, LOCALIZACAO) VALUES ('Sony Next Gen', '2019', 60, 'SETOR B');
INSERT INTO ESTANDE(TITULO, EVENTO, TAMANHO, LOCALIZACAO) VALUES ('Nintendo Ultra', '2018', 70, 'SETOR A');
INSERT INTO ESTANDE(TITULO, EVENTO, TAMANHO, LOCALIZACAO) VALUES ('Redbull Xtreme', '2018', 120, 'SETOR A');
INSERT INTO ESTANDE(TITULO, EVENTO, TAMANHO, LOCALIZACAO) VALUES ('Sony Zone', '2018', 60, 'SETOR B');
INSERT INTO ESTANDE(TITULO, EVENTO, TAMANHO, LOCALIZACAO) VALUES ('Nintendo Area', '2017', 70, 'SETOR A');
INSERT INTO ESTANDE(TITULO, EVENTO, TAMANHO, LOCALIZACAO) VALUES ('Redbull Xtreme', '2017', 120, 'SETOR A');
INSERT INTO ESTANDE(TITULO, EVENTO, TAMANHO, LOCALIZACAO) VALUES ('SoNy', '2017', 60, 'SETOR B');